<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BM432 Project Timeline Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Material Design 3 Color System */
            --md-sys-color-primary: #1565C0;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #D3E3FD;
            --md-sys-color-on-primary-container: #001C3B;
            
            --md-sys-color-secondary: #5A6069;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #DEE3EA;
            --md-sys-color-on-secondary-container: #171B20;
            
            --md-sys-color-surface: #FEFBFF;
            --md-sys-color-on-surface: #1B1B1F;
            --md-sys-color-surface-variant: #E0E2EC;
            --md-sys-color-on-surface-variant: #44474E;
            
            --md-sys-color-outline: #74777F;
            --md-sys-color-outline-variant: #C4C6CF;
            
            --md-sys-color-success: #4CAF50;
            --md-sys-color-warning: #FF9800;
            --md-sys-color-error: #F44336;
            
            /* Material Design 3 Elevation Shadows */
            --md-elevation-1: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-elevation-3: 0px 1px 3px 0px rgba(0, 0, 0, 0.3), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', system-ui, sans-serif;
            line-height: 1.5;
            color: var(--md-sys-color-on-surface);
            background-color: var(--md-sys-color-surface);
        }
        
        .header {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 24px 0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 400;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.87;
        }
        
        .controls {
            background: white;
            border-radius: 12px;
            box-shadow: var(--md-elevation-1);
            padding: 24px;
            margin: 24px 0;
        }
        
        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 11px;
        }
        
        .task-form {
            background: var(--md-sys-color-primary-container);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .task-form h3 {
            color: var(--md-sys-color-on-primary-container);
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 80px 100px;
            gap: 16px;
            align-items: end;
            margin-bottom: 16px;
        }
        
        .color-picker {
            width: 60px;
            height: 40px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        
        .btn-secondary {
            background-color: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }
        
        .btn-success {
            background-color: var(--md-sys-color-success);
            color: white;
        }
        
        .btn-error {
            background-color: var(--md-sys-color-error);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--md-elevation-1);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        
        .gantt-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--md-elevation-1);
            margin-bottom: 24px;
        }
        
        .project-header {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 20px;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid var(--md-sys-color-primary);
        }
        
        .project-header-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            font-size: 14px;
        }
        
        .project-header-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .project-header-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }
        
        .project-header-value {
            font-weight: 500;
        }
        
        .gantt-chart {
            overflow-x: auto;
        }
        
        .gantt-table {
            width: 100%;
            min-width: 1400px;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .gantt-header {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .gantt-header th {
            padding: 16px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gantt-header th.task-header {
            width: 300px;
            text-align: left;
            padding-left: 20px;
        }
        
        .week-header {
            width: 60px;
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            line-height: 1.2;
        }
        
        .gantt-row {
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            transition: background-color 0.2s;
        }
        
        .gantt-row:hover {
            background-color: var(--md-sys-color-surface-variant);
        }
        
        .gantt-row.selected {
            background-color: var(--md-sys-color-primary-container);
        }
        
        .task-name-cell {
            width: 300px;
            padding: 16px 20px;
            border-right: 2px solid var(--md-sys-color-outline-variant);
            background: var(--md-sys-color-surface);
            cursor: pointer;
        }
        
        .task-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--md-sys-color-on-surface);
        }
        
        .task-category {
            font-size: 11px;
            color: var(--md-sys-color-on-surface-variant);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .category-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .category-header {
            background-color: var(--md-sys-color-surface-variant);
            font-weight: 600;
        }
        
        .category-cell {
            background-color: var(--md-sys-color-surface-variant);
        }
        
        .category-header-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .category-timeline {
            background-color: var(--md-sys-color-surface-variant);
        }
        
        .subtask-content {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .subtask-indent {
            color: var(--md-sys-color-outline);
            font-size: 12px;
            font-family: monospace;
            margin-top: 2px;
        }
        
        .timeline-cell {
            width: 60px;
            height: 60px;
            border-right: 1px solid var(--md-sys-color-outline-variant);
            position: relative;
            background: white;
            overflow: visible;
        }
        
        .task-bar {
            position: absolute;
            top: 12px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 6px;
            color: white;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--md-elevation-1);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            z-index: 1;
        }
        
        .task-bar:hover {
            transform: translateY(-50%) scale(1.02);
            box-shadow: var(--md-elevation-3);
        }
        
        .task-bar.selected {
            box-shadow: 0 0 0 2px var(--md-sys-color-primary);
        }
        
        .task-bar.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .progress-section {
            background: white;
            border-radius: 12px;
            box-shadow: var(--md-elevation-1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .progress-bar {
            background: var(--md-sys-color-surface-variant);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }
        
        .progress-fill {
            background: var(--md-sys-color-success);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: var(--md-elevation-3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        
        .modal-header h3 {
            font-size: 18px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: var(--md-sys-color-surface-variant);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }
        
        .tips {
            background: var(--md-sys-color-secondary-container);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }
        
        .tips h3 {
            color: var(--md-sys-color-on-secondary-container);
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .tips ul {
            color: var(--md-sys-color-on-secondary-container);
            list-style-position: inside;
        }
        
        .tips li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .gantt-table {
                min-width: 800px;
            }
            
            .week-header {
                width: 40px;
            }
            
            .timeline-cell {
                width: 40px;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--md-sys-color-on-surface-variant);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>BM432 Project Timeline Planner</h1>
            <p>Strategic planning tool for final year projects • 2025-2026</p>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="project-info">
                <div class="input-group">
                    <label for="project-title">Project Title</label>
                    <input type="text" id="project-title" placeholder="Enter your project title">
                </div>
                <div class="input-group">
                    <label for="student-name">Student Name</label>
                    <input type="text" id="student-name" placeholder="Your name">
                </div>
                <div class="input-group">
                    <label for="supervisor">Supervisor</label>
                    <input type="text" id="supervisor" placeholder="Supervisor name">
                </div>
                <div class="input-group">
                    <label for="project-type">Project Type</label>
                    <select id="project-type">
                        <option value="">Select project type</option>
                        <option value="Meta-analysis">Meta-analysis</option>
                        <option value="Laboratory Research">Laboratory Research</option>
                        <option value="Data Analysis">Data Analysis</option>
                        <option value="Computational">Computational</option>
                        <option value="Literature Review">Literature Review</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="total-weeks">Timeline (weeks)</label>
                    <input type="number" id="total-weeks" min="10" max="52" value="20" onchange="updateTimelineWeeks()">
                </div>
            </div>
            
            <div class="task-form">
                <h3>Add New Task</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="task-name">Task Name</label>
                        <input type="text" id="task-name" placeholder="Enter task name">
                    </div>
                    <div class="input-group">
                        <label for="task-category">Category</label>
                        <input type="text" id="task-category" placeholder="e.g. Literature, Analysis">
                    </div>
                    <div class="input-group">
                        <label for="task-duration">Duration (weeks)</label>
                        <input type="number" id="task-duration" min="1" max="20" value="2">
                    </div>
                    <div class="input-group">
                        <label for="start-week">Start Week</label>
                        <select id="start-week">
                            <option value="0">Sep W3</option>
                            <option value="1">Sep W4</option>
                            <option value="2">Oct W1</option>
                            <option value="3">Oct W2</option>
                            <option value="4">Oct W3</option>
                            <option value="5">Oct W4</option>
                            <option value="6">Nov W1</option>
                            <option value="7">Nov W2</option>
                            <option value="8">Nov W3</option>
                            <option value="9">Nov W4</option>
                            <option value="10">Dec W1</option>
                            <option value="11">Dec W2</option>
                            <option value="12">Jan W2</option>
                            <option value="13">Jan W3</option>
                            <option value="14">Jan W4</option>
                            <option value="15">Feb W1</option>
                            <option value="16">Feb W2</option>
                            <option value="17">Feb W3</option>
                            <option value="18">Feb W4</option>
                            <option value="19">Mar W1</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Color</label>
                        <input type="color" id="task-color" class="color-picker" value="#1565C0">
                    </div>
                </div>
                <div class="input-group">
                    <label for="task-notes">Notes (optional)</label>
                    <textarea id="task-notes" rows="2" placeholder="Additional notes about this task"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addTask()">Add Task</button>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="editSelected()">Edit Task</button>
                <button class="btn btn-error" onclick="deleteSelected()">Delete Task</button>
                <button class="btn btn-secondary" onclick="customizeWeekLabels()">Customize Week Labels</button>
                <button class="btn btn-success" onclick="saveProject()">Save Project</button>
                <button class="btn btn-secondary" onclick="loadProject()">Load Project</button>
                <button class="btn btn-primary" onclick="exportChart()">Export Chart</button>
                <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
            </div>
        </div>
        
        <div class="gantt-container">
            <div class="gantt-chart">
                <table class="gantt-table" id="gantt-table">
                    <thead class="gantt-header">
                        <tr>
                            <th class="task-header">Task</th>
                            <th class="week-header">Sep<br>W3</th>
                            <th class="week-header">Sep<br>W4</th>
                            <th class="week-header">Oct<br>W1</th>
                            <th class="week-header">Oct<br>W2</th>
                            <th class="week-header">Oct<br>W3</th>
                            <th class="week-header">Oct<br>W4</th>
                            <th class="week-header">Nov<br>W1</th>
                            <th class="week-header">Nov<br>W2</th>
                            <th class="week-header">Nov<br>W3</th>
                            <th class="week-header">Nov<br>W4</th>
                            <th class="week-header">Dec<br>W1</th>
                            <th class="week-header">Dec<br>W2</th>
                            <th class="week-header">Jan<br>W2</th>
                            <th class="week-header">Jan<br>W3</th>
                            <th class="week-header">Jan<br>W4</th>
                            <th class="week-header">Feb<br>W1</th>
                            <th class="week-header">Feb<br>W2</th>
                            <th class="week-header">Feb<br>W3</th>
                            <th class="week-header">Feb<br>W4</th>
                            <th class="week-header">Mar<br>W1</th>
                        </tr>
                    </thead>
                    <tbody id="gantt-body">
                        <!-- Tasks will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="progress-section">
            <h3>Project Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progress-text">0% Complete (0 of 0 tasks)</p>
        </div>
    </div>

    <!-- Week Labels Customization Modal -->
    <div id="weekLabelsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Customize Week Labels</h3>
                <button class="close-btn" onclick="closeWeekLabelsModal()">&times;</button>
            </div>
            <div style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
                Edit the labels for each week in your timeline. Leave blank to use default "Week #" format.
            </div>
            <div id="week-labels-form" style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto;">
                <!-- Week label inputs will be generated here -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="resetWeekLabels()">Reset to Defaults</button>
                <button type="button" class="btn btn-secondary" onclick="closeWeekLabelsModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWeekLabels()">Save Labels</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Task</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form onsubmit="saveTaskEdit(event)">
                <div class="input-group">
                    <label for="edit-task-name">Task Name</label>
                    <input type="text" id="edit-task-name" required>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="edit-task-category">Category</label>
                        <input type="text" id="edit-task-category" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-task-color">Color</label>
                        <input type="color" id="edit-task-color" class="color-picker">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="edit-task-duration">Duration (weeks)</label>
                        <input type="number" id="edit-task-duration" min="1" max="20" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-start-week">Start Week</label>
                        <select id="edit-start-week" required>
                            <option value="0">Sep W3</option>
                            <option value="1">Sep W4</option>
                            <option value="2">Oct W1</option>
                            <option value="3">Oct W2</option>
                            <option value="4">Oct W3</option>
                            <option value="5">Oct W4</option>
                            <option value="6">Nov W1</option>
                            <option value="7">Nov W2</option>
                            <option value="8">Nov W3</option>
                            <option value="9">Nov W4</option>
                            <option value="10">Dec W1</option>
                            <option value="11">Dec W2</option>
                            <option value="12">Jan W2</option>
                            <option value="13">Jan W3</option>
                            <option value="14">Jan W4</option>
                            <option value="15">Feb W1</option>
                            <option value="16">Feb W2</option>
                            <option value="17">Feb W3</option>
                            <option value="18">Feb W4</option>
                            <option value="19">Mar W1</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label for="edit-task-notes">Notes</label>
                    <textarea id="edit-task-notes" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="edit-task-completed" style="margin-right: 8px;">
                        Mark as completed
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let tasks = [];
        let selectedTask = null;
        let taskIdCounter = 1;
        
        // Configuration - easily adjustable
        const CONFIG = {
            totalWeeks: 20,
            weekLabels: [
                'Sep W3', 'Sep W4', 'Oct W1', 'Oct W2', 'Oct W3', 'Oct W4',
                'Nov W1', 'Nov W2', 'Nov W3', 'Nov W4', 'Dec W1', 'Dec W2',
                'Jan W2', 'Jan W3', 'Jan W4', 'Feb W1', 'Feb W2', 'Feb W3', 'Feb W4', 'Mar W1'
            ]
        };
        
        // Generate week headers dynamically
        function generateWeekHeaders() {
            const headerRow = document.querySelector('.gantt-header tr');
            const taskHeader = headerRow.querySelector('.task-header');
            
            // Clear existing week headers
            const existingHeaders = headerRow.querySelectorAll('.week-header');
            existingHeaders.forEach(header => header.remove());
            
            // Add new week headers
            for (let i = 0; i < CONFIG.totalWeeks; i++) {
                const th = document.createElement('th');
                th.className = 'week-header';
                th.textContent = CONFIG.weekLabels[i] || `Week ${i + 1}`;
                headerRow.appendChild(th);
            }
        }
        
        // Update timeline when user changes number of weeks
        function updateTimelineWeeks() {
            const totalWeeksInput = document.getElementById('total-weeks');
            const newTotal = parseInt(totalWeeksInput.value);
            
            if (newTotal < 10 || newTotal > 52 || isNaN(newTotal)) {
                alert('Please enter a number between 10 and 52 weeks');
                totalWeeksInput.value = CONFIG.totalWeeks;
                return;
            }
            
            // Update configuration
            CONFIG.totalWeeks = newTotal;
            
            // Generate default week labels if we don't have enough
            while (CONFIG.weekLabels.length < newTotal) {
                CONFIG.weekLabels.push(`Week ${CONFIG.weekLabels.length + 1}`);
            }
            
            // Update start week options in forms
            updateStartWeekOptions();
            
            // Regenerate chart
            generateWeekHeaders();
            renderChart();
        }
        
        // Update the start week dropdown options
        function updateStartWeekOptions() {
            const startWeekSelects = document.querySelectorAll('#start-week, #edit-start-week');
            
            startWeekSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                
                for (let i = 0; i < CONFIG.totalWeeks; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = CONFIG.weekLabels[i] || `Week ${i + 1}`;
                    select.appendChild(option);
                }
                
                // Restore previous selection if still valid
                if (currentValue < CONFIG.totalWeeks) {
                    select.value = currentValue;
                }
            });
        }
        
        // Open week labels customization modal
        function customizeWeekLabels() {
            const modal = document.getElementById('weekLabelsModal');
            const form = document.getElementById('week-labels-form');
            
            // Generate input fields for each week
            form.innerHTML = '';
            for (let i = 0; i < CONFIG.totalWeeks; i++) {
                const div = document.createElement('div');
                div.style.display = 'grid';
                div.style.gridTemplateColumns = '100px 1fr';
                div.style.gap = '12px';
                div.style.alignItems = 'center';
                
                const label = document.createElement('label');
                label.textContent = `Week ${i + 1}:`;
                label.style.fontWeight = '500';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `week-label-${i}`;
                input.value = CONFIG.weekLabels[i] || '';
                input.placeholder = `Week ${i + 1}`;
                input.style.padding = '8px';
                input.style.border = '1px solid var(--md-sys-color-outline)';
                input.style.borderRadius = '4px';
                
                div.appendChild(label);
                div.appendChild(input);
                form.appendChild(div);
            }
            
            modal.style.display = 'block';
        }
        
        // Close week labels modal
        function closeWeekLabelsModal() {
            document.getElementById('weekLabelsModal').style.display = 'none';
        }
        
        // Save week labels
        function saveWeekLabels() {
            for (let i = 0; i < CONFIG.totalWeeks; i++) {
                const input = document.getElementById(`week-label-${i}`);
                CONFIG.weekLabels[i] = input.value.trim() || `Week ${i + 1}`;
            }
            
            // Update the chart and form options
            generateWeekHeaders();
            updateStartWeekOptions();
            closeWeekLabelsModal();
        }
        
        // Reset week labels to default
        function resetWeekLabels() {
            if (confirm('Reset all week labels to default format (Week 1, Week 2, etc.)?')) {
                CONFIG.weekLabels = [];
                for (let i = 0; i < CONFIG.totalWeeks; i++) {
                    CONFIG.weekLabels[i] = `Week ${i + 1}`;
                    const input = document.getElementById(`week-label-${i}`);
                    if (input) input.value = '';
                }
            }
        }
        
        // Initialize with meta-analysis example tasks
        function initializeExampleTasks() {
            tasks = [
                {
                    id: taskIdCounter++,
                    name: 'Initial Topic Exploration & Reading',
                    category: 'Exploratory Phase',
                    startWeek: 0,
                    duration: 2,
                    color: '#9C27B0',
                    notes: 'Broad reading to understand the topic and identify key themes',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Refine Research Question & Protocol',
                    category: 'Exploratory Phase',
                    startWeek: 3,
                    duration: 1,
                    color: '#9C27B0',
                    notes: 'Define PICO framework and search strategy',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Systematic Literature Search',
                    category: 'Systematic Review',
                    startWeek: 4,
                    duration: 2,
                    color: '#1565C0',
                    notes: 'Search databases using developed strategy',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Title & Abstract Screening',
                    category: 'Systematic Review',
                    startWeek: 6,
                    duration: 2,
                    color: '#1565C0',
                    notes: 'Apply inclusion/exclusion criteria systematically',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Full-Text Article Review',
                    category: 'Systematic Review',
                    startWeek: 8,
                    duration: 2,
                    color: '#1565C0',
                    notes: 'Detailed eligibility assessment',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Data Extraction',
                    category: 'Data Processing',
                    startWeek: 10,
                    duration: 2,
                    color: '#F57C00',
                    notes: 'Extract study characteristics and outcomes',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Quality Assessment',
                    category: 'Data Processing',
                    startWeek: 12,
                    duration: 2,
                    color: '#F57C00',
                    notes: 'Assess risk of bias in included studies',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Statistical Analysis & Synthesis',
                    category: 'Analysis',
                    startWeek: 14,
                    duration: 2,
                    color: '#E64A19',
                    notes: 'Quantitative synthesis if appropriate, or narrative synthesis',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Draft Introduction Chapter',
                    category: 'Thesis Writing',
                    startWeek: 1,
                    duration: 3,
                    color: '#455A64',
                    notes: 'Write background and rationale during exploratory phase',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Write Methods Section',
                    category: 'Thesis Writing',
                    startWeek: 4,
                    duration: 3,
                    color: '#455A64',
                    notes: 'Document methodology as you implement it',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Write Results Section',
                    category: 'Thesis Writing',
                    startWeek: 13,
                    duration: 2,
                    color: '#455A64',
                    notes: 'Document findings as data emerges',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Update Results with Analysis',
                    category: 'Thesis Writing',
                    startWeek: 15,
                    duration: 2,
                    color: '#455A64',
                    notes: 'Incorporate statistical findings into results chapter',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Discussion & Conclusions',
                    category: 'Thesis Writing',
                    startWeek: 17,
                    duration: 2,
                    color: '#455A64',
                    notes: 'Interpret findings and discuss implications',
                    completed: false
                },
                {
                    id: taskIdCounter++,
                    name: 'Final Review & Submission',
                    category: 'Thesis Writing',
                    startWeek: 19,
                    duration: 1,
                    color: '#455A64',
                    notes: 'Proofread, format, and submit',
                    completed: false
                }
            ];
        }
        
        function renderChart() {
            const tbody = document.getElementById('gantt-body');
            tbody.innerHTML = '';
            
            if (tasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${CONFIG.totalWeeks + 1}" class="empty-state"><h3>No tasks yet</h3><p>Add your first task above to get started</p></td></tr>`;
                return;
            }
            
            // Group tasks by category
            const groupedTasks = {};
            tasks.forEach(task => {
                if (!groupedTasks[task.category]) {
                    groupedTasks[task.category] = [];
                }
                groupedTasks[task.category].push(task);
            });
            
            // Render grouped tasks
            Object.keys(groupedTasks).forEach(category => {
                const categoryTasks = groupedTasks[category];
                
                // Add category header if there are multiple tasks in this category
                if (categoryTasks.length > 1) {
                    const categoryRow = document.createElement('tr');
                    categoryRow.className = 'gantt-row category-header';
                    
                    const categoryCell = document.createElement('td');
                    categoryCell.className = 'task-name-cell category-cell';
                    categoryCell.innerHTML = `
                        <div class="category-header-content">
                            <span class="category-dot" style="background-color: ${categoryTasks[0].color}"></span>
                            <strong>${category}</strong>
                        </div>
                    `;
                    categoryRow.appendChild(categoryCell);
                    
                    // Add empty timeline cells for category header
                    for (let week = 0; week < CONFIG.totalWeeks; week++) {
                        const cell = document.createElement('td');
                        cell.className = 'timeline-cell category-timeline';
                        categoryRow.appendChild(cell);
                    }
                    
                    tbody.appendChild(categoryRow);
                }
                
                // Add individual tasks
                categoryTasks.forEach((task, index) => {
                    const row = document.createElement('tr');
                    row.className = 'gantt-row';
                    row.setAttribute('data-task-id', task.id);
                    
                    if (selectedTask && selectedTask.id === task.id) {
                        row.classList.add('selected');
                    }
                    
                    // Task name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'task-name-cell';
                    
                    if (categoryTasks.length > 1) {
                        // Show as subtask
                        nameCell.innerHTML = `
                            <div class="subtask-content">
                                <span class="subtask-indent">├</span>
                                <div class="task-title">${task.name}</div>
                            </div>
                        `;
                    } else {
                        // Show as standalone task with category
                        nameCell.innerHTML = `
                            <div class="task-category">
                                <span class="category-dot" style="background-color: ${task.color}"></span>
                                ${task.category}
                            </div>
                            <div class="task-title">${task.name}</div>
                        `;
                    }
                    
                    nameCell.addEventListener('click', () => selectTask(task));
                    row.appendChild(nameCell);
                    
                    // Timeline cells
                    for (let week = 0; week < CONFIG.totalWeeks; week++) {
                        const cell = document.createElement('td');
                        cell.className = 'timeline-cell';
                        
                        // Only add task bar on the first week of the task
                        if (week === task.startWeek) {
                            const taskBar = document.createElement('div');
                            taskBar.className = 'task-bar';
                            if (selectedTask && selectedTask.id === task.id) {
                                taskBar.classList.add('selected');
                            }
                            if (task.completed) {
                                taskBar.classList.add('completed');
                            }
                            
                            taskBar.style.backgroundColor = task.color;
                            
                            // Calculate the full width of the bar across multiple cells
                            const barWidth = (task.duration * 60) - 4;
                            taskBar.style.left = '2px';
                            taskBar.style.width = `${barWidth}px`;
                            
                            // Just use the full task name - let CSS handle truncation
                            taskBar.textContent = task.name;
                            
                            taskBar.setAttribute('data-task-id', task.id);
                            taskBar.addEventListener('click', (e) => {
                                e.stopPropagation();
                                selectTask(task);
                            });
                            taskBar.addEventListener('dblclick', () => {
                                task.completed = !task.completed;
                                renderChart();
                                updateProgress();
                            });
                            
                            taskBar.title = `${task.name}\nCategory: ${task.category}\nDuration: ${task.duration} weeks\n${task.notes ? 'Notes: ' + task.notes : ''}`;
                            
                            cell.appendChild(taskBar);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    tbody.appendChild(row);
                });
            });
        }
        
        function selectTask(task) {
            selectedTask = task;
            renderChart();
        }
        
        function addTask() {
            const name = document.getElementById('task-name').value.trim();
            const category = document.getElementById('task-category').value.trim();
            const duration = parseInt(document.getElementById('task-duration').value);
            const startWeek = parseInt(document.getElementById('start-week').value);
            const color = document.getElementById('task-color').value;
            const notes = document.getElementById('task-notes').value.trim();
            
            if (!name) {
                alert('Please enter a task name');
                return;
            }
            
            if (!category) {
                alert('Please enter a category');
                return;
            }
            
            const newTask = {
                id: taskIdCounter++,
                name: name,
                category: category,
                startWeek: startWeek,
                duration: duration,
                color: color,
                notes: notes,
                completed: false
            };
            
            tasks.push(newTask);
            
            // Clear form
            document.getElementById('task-name').value = '';
            document.getElementById('task-category').value = '';
            document.getElementById('task-duration').value = '2';
            document.getElementById('start-week').value = '0';
            document.getElementById('task-color').value = '#1565C0';
            document.getElementById('task-notes').value = '';
            
            renderChart();
            updateProgress();
        }
        
        function editSelected() {
            if (!selectedTask) {
                alert('Please select a task to edit');
                return;
            }
            
            // Populate edit form
            document.getElementById('edit-task-name').value = selectedTask.name;
            document.getElementById('edit-task-category').value = selectedTask.category;
            document.getElementById('edit-task-color').value = selectedTask.color;
            document.getElementById('edit-task-duration').value = selectedTask.duration;
            document.getElementById('edit-start-week').value = selectedTask.startWeek;
            document.getElementById('edit-task-notes').value = selectedTask.notes || '';
            document.getElementById('edit-task-completed').checked = selectedTask.completed;
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function saveTaskEdit(event) {
            event.preventDefault();
            
            if (!selectedTask) return;
            
            selectedTask.name = document.getElementById('edit-task-name').value;
            selectedTask.category = document.getElementById('edit-task-category').value;
            selectedTask.color = document.getElementById('edit-task-color').value;
            selectedTask.duration = parseInt(document.getElementById('edit-task-duration').value);
            selectedTask.startWeek = parseInt(document.getElementById('edit-start-week').value);
            selectedTask.notes = document.getElementById('edit-task-notes').value;
            selectedTask.completed = document.getElementById('edit-task-completed').checked;
            
            closeEditModal();
            renderChart();
            updateProgress();
        }
        
        function deleteSelected() {
            if (!selectedTask) {
                alert('Please select a task to delete');
                return;
            }
            
            if (confirm(`Delete "${selectedTask.name}"?`)) {
                tasks = tasks.filter(t => t.id !== selectedTask.id);
                selectedTask = null;
                renderChart();
                updateProgress();
            }
        }
        
        function clearAll() {
            if (confirm('Delete all tasks? This cannot be undone.')) {
                tasks = [];
                selectedTask = null;
                renderChart();
                updateProgress();
            }
        }
        
        function updateProgress() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = 
                `${percentage}% Complete (${completedTasks} of ${totalTasks} tasks)`;
        }
        
        function saveProject() {
            const projectData = {
                title: document.getElementById('project-title').value,
                student: document.getElementById('student-name').value,
                supervisor: document.getElementById('supervisor').value,
                type: document.getElementById('project-type').value,
                tasks: tasks,
                created: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${projectData.title || 'project-timeline'}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        
                        // Load project info
                        document.getElementById('project-title').value = projectData.title || '';
                        document.getElementById('student-name').value = projectData.student || '';
                        document.getElementById('supervisor').value = projectData.supervisor || '';
                        document.getElementById('project-type').value = projectData.type || '';
                        
                        // Load tasks
                        tasks = projectData.tasks || [];
                        taskIdCounter = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                        selectedTask = null;
                        
                        renderChart();
                        updateProgress();
                        
                        alert('Project loaded successfully!');
                    } catch (error) {
                        alert('Error loading project file. Please check the format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function exportChart() {
            alert('To export your timeline:\n\n1. Take a screenshot of the chart\n2. Use browser print function (Ctrl+P)\n3. Or use browser developer tools to capture');
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editModal');
            const weekLabelsModal = document.getElementById('weekLabelsModal');
            
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === weekLabelsModal) {
                closeWeekLabelsModal();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
            }
            if (event.key === 'Delete' && selectedTask) {
                deleteSelected();
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            generateWeekHeaders();
            updateStartWeekOptions();
            initializeExampleTasks();
            renderChart();
            updateProgress();
            updateProjectHeader();
            
            // Add event listeners to update project header when fields change
            document.getElementById('project-title').addEventListener('input', updateProjectHeader);
            document.getElementById('student-name').addEventListener('input', updateProjectHeader);
            document.getElementById('supervisor').addEventListener('input', updateProjectHeader);
            document.getElementById('project-type').addEventListener('change', updateProjectHeader);
            document.getElementById('total-weeks').addEventListener('change', updateProjectHeader);
        });
        
        // Update the project header display
        function updateProjectHeader() {
            const displayTitle = document.getElementById('display-project-title');
            const displayStudent = document.getElementById('display-student-name');
            const displaySupervisor = document.getElementById('display-supervisor');
            const displayType = document.getElementById('display-project-type');
            const displayTimeline = document.getElementById('display-timeline');
            const displayDate = document.getElementById('display-date');
            
            if (displayTitle) displayTitle.textContent = document.getElementById('project-title').value || 'Not specified';
            if (displayStudent) displayStudent.textContent = document.getElementById('student-name').value || 'Not specified';
            if (displaySupervisor) displaySupervisor.textContent = document.getElementById('supervisor').value || 'Not specified';
            if (displayType) displayType.textContent = document.getElementById('project-type').value || 'Not specified';
            if (displayTimeline) displayTimeline.textContent = `${CONFIG.totalWeeks} weeks`;
            if (displayDate) displayDate.textContent = new Date().toLocaleDateString();
        }
    </script>
</body>
</html>
