<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BM432 Final Year Projects 2025-26</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Material Design 3 Color System */
            --md-sys-color-primary: #1565C0;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #D3E3FD;
            --md-sys-color-on-primary-container: #001C3B;
            
            --md-sys-color-secondary: #5A6069;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #DEE3EA;
            --md-sys-color-on-secondary-container: #171B20;
            
            --md-sys-color-surface: #FEFBFF;
            --md-sys-color-on-surface: #1B1B1F;
            --md-sys-color-surface-variant: #E0E2EC;
            --md-sys-color-on-surface-variant: #44474E;
            
            --md-sys-color-outline: #74777F;
            --md-sys-color-outline-variant: #C4C6CF;
            
            /* Additional colors for new features */
            --md-sys-color-success: #4CAF50;
            --md-sys-color-on-success: #FFFFFF;
            --md-sys-color-warning: #FF9800;
            --md-sys-color-on-warning: #FFFFFF;
            --md-sys-color-error: #F44336;
            --md-sys-color-on-error: #FFFFFF;
            
            /* Material Design 3 Elevation Shadows */
            --md-elevation-1: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-elevation-3: 0px 1px 3px 0px rgba(0, 0, 0, 0.3), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Roboto', 'Segoe UI', system-ui, sans-serif;
            line-height: 1.5;
            color: var(--md-sys-color-on-surface);
            background-color: var(--md-sys-color-surface);
        }

        .header {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 24px 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 24px;
            align-items: start;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.87;
        }

        /* Saved Projects Panel - Desktop: Always visible, Mobile: Bottom panel */
        .saved-panel {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--md-elevation-1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 32px);
            position: sticky;
            top: 16px;
        }

        /* Mobile saved panel */
        @media (max-width: 1024px) {
            .saved-panel {
                position: fixed;
                bottom: -100vh;
                left: 0;
                right: 0;
                height: 100dvh;
                max-height: 100dvh;
                border-radius: 0;
                box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                transition: bottom 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
                top: auto;
            }

            .saved-panel.open {
                bottom: 0;
            }
        }

        .saved-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 12px 12px 0 0;
        }

        @media (max-width: 1024px) {
            .saved-panel-header {
                border-radius: 0;
            }
        }

        .saved-panel-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .saved-panel-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        .saved-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .saved-panel-actions {
            padding: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            background-color: var(--md-sys-color-surface-variant);
        }

        .saved-project-item {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
        }

        .saved-project-item:hover {
            background-color: var(--md-sys-color-primary-container);
        }

        .saved-project-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .saved-project-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        .saved-project-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .saved-project-meta {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .saved-project-remove {
            background: none;
            border: none;
            color: var(--md-sys-color-error);
            cursor: pointer;
            font-size: 18px;
            float: right;
            padding: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .saved-project-remove:hover {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        /* Panel Toggle Button - Only visible on mobile */
        .saved-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: var(--md-elevation-3);
            cursor: pointer;
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }

        .saved-toggle:hover {
            transform: scale(1.1);
        }

        @media (max-width: 1024px) {
            .saved-toggle {
                display: flex;
            }
        }

        .saved-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filters {
            padding: 16px 0;
            margin: 16px 0;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .reset-button {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border: 1px solid var(--md-sys-color-outline);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .reset-button:hover {
            background-color: var(--md-sys-color-outline-variant);
        }

        .reset-button:active {
            transform: scale(0.98);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 16px;
        }

        .filter-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 11px;
        }

        .results-summary {
            text-align: center;
            margin: 24px 0 16px 0;
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        /* Project Cards */
        .project-card {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: var(--md-elevation-1);
            transition: all 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .project-card.saved {
            border: 2px solid var(--md-sys-color-primary);
        }

        .project-card:hover {
            box-shadow: var(--md-elevation-3);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px 20px 16px 20px;
            position: relative;
        }

        .card-content {
            padding: 0 20px 16px 20px;
        }

        .card-actions {
            padding: 16px 20px 20px 20px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .project-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 12px;
            line-height: 1.3;
            padding-right: 40px;
        }

        /* Save Button */
        .save-button {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: 2px solid var(--md-sys-color-primary);
            color: var(--md-sys-color-primary);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .save-button.saved {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .save-button:hover {
            transform: scale(1.1);
        }

        .project-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .meta-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Project Type Colors */
        .meta-chip.type[data-type*="Data Science"] {
            background-color: #E8F4FD;
            color: #1976D2;
        }

        .meta-chip.type[data-type*="Experimental"] {
            background-color: #F3E5F5;
            color: #7B1FA2;
        }

        .meta-chip.type[data-type*="Industrial"] {
            background-color: #E1F5FE;
            color: #0277BD;
        }

        .meta-chip.type[data-type*="Literature"] {
            background-color: #E8F5E8;
            color: #43A047;
        }

        .subject-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .subject-chip {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        /* Project Aim - Highlighted */
        .project-aim {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .project-aim strong {
            font-weight: 500;
        }

        /* Expandable Details */
        .project-details {
            display: none;
            padding: 16px 20px 0 20px;
        }

        .expanded .project-details {
            display: block;
        }

        .section-label {
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-outline {
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
            line-height: 1.5;
            font-size: 14px;
        }

        .techniques-section {
            margin-bottom: 16px;
        }

        .techniques-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .technique-chip {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .references-section {
            margin-bottom: 16px;
        }

        .references-list {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.4;
        }

        .reference {
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 2px solid var(--md-sys-color-outline-variant);
        }

        .supervisor-info {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 12px;
        }

        .supervisor-info strong {
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
        }

        /* Expand Button */
        .expand-button {
            background: none;
            border: none;
            color: var(--md-sys-color-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }

        .expand-button:hover {
            color: var(--md-sys-color-on-surface);
        }

        .expand-icon {
            transition: transform 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Export and Action Buttons */
        .panel-button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .panel-button.primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .panel-button.secondary {
            background-color: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .panel-button.danger {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .panel-button:hover {
            transform: translateY(-1px);
            box-shadow: var(--md-elevation-1);
        }

        .no-saved-projects {
            text-align: center;
            padding: 32px 16px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .no-saved-projects h3 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .no-saved-projects p {
            font-size: 14px;
            line-height: 1.4;
        }

        .no-results {
            text-align: center;
            padding: 48px 24px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        /* Close button for saved panel - Only visible on mobile */
        .close-panel-button {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--md-sys-color-on-primary);
            cursor: pointer;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .close-panel-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 1024px) {
            .close-panel-button {
                display: flex;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 0 12px;
            }

            .saved-toggle {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>BM432 Final Year Projects</h1>
            <p>Biomolecular Science • 2025-2026</p>
        </div>
    </div>

    <!-- Floating Toggle Button - Only visible on mobile -->
    <button class="saved-toggle" onclick="toggleSavedPanel()">
        +
        <span class="saved-badge" id="savedBadge" style="display: none;">0</span>
    </button>

    <div class="container">
        <div class="main-content" style="margin-top: 32px;">
            <div class="content-section">
                <div class="filters">
                    <div class="filters-header">
                        <h2 style="font-size: 18px; font-weight: 500; color: var(--md-sys-color-on-surface); margin: 0;">Filter Projects</h2>
                        <button class="reset-button" onclick="resetAllFilters()">Reset all filters</button>
                    </div>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="searchInput">Search projects</label>
                            <input type="text" id="searchInput" placeholder="Search by title, keywords, techniques...">
                        </div>
                        <div class="filter-group">
                            <label for="typeFilter">Project type</label>
                            <select id="typeFilter">
                                <option value="">All types</option>
                                <option value="Data Science: Data Analysis">Data Analysis</option>
                                <option value="Data Science: Bioinformatics">Bioinformatics</option>
                                <option value="Data Science: Computational">Computational</option>
                                <option value="Experimental Research Projects (Laboratory)">Laboratory Research</option>
                                <option value="Industrial/Societal: Education">Education</option>
                                <option value="Industrial/Societal: Knowledge Exchange">Knowledge Exchange</option>
                                <option value="Industrial/Societal: SciComm & Public Engagement">Science Communication</option>
                                <option value="Literature: Critical Analysis">Literature (Critical Analysis)</option>
                                <option value="Literature: Meta-analysis">Meta-analysis</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="subjectFilter">Subject area</label>
                            <select id="subjectFilter">
                                <option value="">All subjects</option>
                                <option value="Biochemistry">Biochemistry</option>
                                <option value="Immunology">Immunology</option>
                                <option value="Microbiology">Microbiology</option>
                                <option value="Pharmacology">Pharmacology</option>
                                <option value="Biomedical Science">Biomedical Science</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="supervisorFilter">Supervisor</label>
                            <select id="supervisorFilter">
                                <option value="">All supervisors</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="sortFilter">Sort by</label>
                            <select id="sortFilter">
                                <option value="random">Default order</option>
                                <option value="title">Project title A-Z</option>
                                <option value="supervisor">Supervisor A-Z</option>
                                <option value="type">Project type</option>
                                <option value="id">Project ID</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="results-summary">
                    Showing <strong><span id="resultCount">0</span></strong> available projects
                </div>

                <div class="projects-grid" id="projectsGrid">
                    <!-- Projects will be loaded here -->
                </div>

                <div class="no-results" id="noResults" style="display: none;">
                    <h3>No projects found</h3>
                    <p>Try adjusting your search criteria or filters to see more results.</p>
                </div>
            </div>

            <!-- Saved Projects Panel - Always visible on desktop -->
            <div class="saved-panel" id="savedPanel">
                <div class="saved-panel-header">
                    <button class="close-panel-button" onclick="toggleSavedPanel()">×</button>
                    <div class="saved-panel-title">My Project Preferences</div>
                    <div class="saved-panel-subtitle">Drag to reorder by preference • <span id="projectCount">0</span>/30 selected</div>
                </div>
                <div class="saved-panel-content">
                    <div id="savedProjectsList">
                        <div class="no-saved-projects">
                            <h3>No projects saved yet</h3>
                            <p>Click the heart icon on projects you're interested in to add them to your list.</p>
                        </div>
                    </div>
                </div>
                <div class="saved-panel-actions">
                    <button class="panel-button primary" onclick="exportProjectList()">Submit via Microsoft Forms</button>
                    <button class="panel-button secondary" onclick="copyProjectList()">Copy to Clipboard</button>
                    <button class="panel-button danger" onclick="clearAllSaved()">Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load projects data -->
    <script src="projects.js"></script>
    <script>
        // Fallback if projects.js doesn't load
        if (typeof projects === 'undefined') {
            console.warn('projects.js not found. Using sample data.');
            window.projects = [
                {
                    id: "BM001",
                    title: "Sample Project - Replace with your data",
                    type: "Data Science: Data Analysis",
                    subjects: ["Biochemistry"],
                    primarySupervisor: "Dr. Sample",
                    secondarySupervisor: null,
                    aim: "This is sample data. Replace with your actual projects.js file.",
                    outline: "Create a projects.js file with your actual project data.",
                    techniques: ["Replace", "With", "Real", "Data"]
                }
            ];
        }
        
        // Projects data is loaded from projects.js
        let filteredProjects = [...projects];
        let savedProjects = JSON.parse(localStorage.getItem('savedProjects')) || [];
        
        // Generate or retrieve daily seed for this user
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
        const seedKey = 'dailyProjectSeed_' + today;
        
        let randomSeed = localStorage.getItem(seedKey);
        if (!randomSeed) {
            randomSeed = Math.random();
            localStorage.setItem(seedKey, randomSeed);
        } else {
            randomSeed = parseFloat(randomSeed);
        }

        document.addEventListener('DOMContentLoaded', function() {
            populateSupervisorFilter();
            
            // Apply initial random sort
            shuffleArray(projects, randomSeed);
            filteredProjects = [...projects];
            
            displayProjects(filteredProjects);
            setupEventListeners();
            updateSavedDisplay();
            
            // Make saved projects list sortable
            initializeSortable();
        });

        function initializeSortable() {
            // Simple drag and drop implementation
            const savedList = document.getElementById('savedProjectsList');
            
            savedList.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            savedList.addEventListener('drop', function(e) {
                e.preventDefault();
                
                const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const dropTarget = e.target.closest('.saved-project-item');
                
                if (dropTarget) {
                    const dropIndex = parseInt(dropTarget.dataset.index);
                    
                    if (draggedIndex !== dropIndex) {
                        // Reorder the savedProjects array
                        const movedProject = savedProjects.splice(draggedIndex, 1)[0];
                        savedProjects.splice(dropIndex, 0, movedProject);
                        
                        // Save to localStorage and update display
                        localStorage.setItem('savedProjects', JSON.stringify(savedProjects));
                        updateSavedDisplay();
                    }
                }
            });
        }

        function populateSupervisorFilter() {
            const supervisorFilter = document.getElementById('supervisorFilter');
            const supervisors = new Set();
            
            // Only add primary supervisors to the dropdown
            projects.forEach(project => {
                supervisors.add(project.primarySupervisor);
            });
        
            Array.from(supervisors).sort().forEach(supervisor => {
                const option = document.createElement('option');
                option.value = supervisor;
                option.textContent = supervisor;
                supervisorFilter.appendChild(option);
            });
        }

        function resetAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('supervisorFilter').value = '';
            document.getElementById('sortFilter').value = 'random';
            
            filterProjects();
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterProjects);
            document.getElementById('typeFilter').addEventListener('change', filterProjects);
            document.getElementById('subjectFilter').addEventListener('change', filterProjects);
            document.getElementById('supervisorFilter').addEventListener('change', filterProjects);
            document.getElementById('sortFilter').addEventListener('change', filterProjects);
        }

        // Seeded random shuffle for consistent random order during session
        function shuffleArray(array, seed) {
            let currentIndex = array.length;
            
            // Simple seeded random number generator
            function seededRandom() {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }
            
            while (currentIndex !== 0) {
                const randomIndex = Math.floor(seededRandom() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            
            return array;
        }

        function sortProjects(projectArray, sortBy) {
            switch (sortBy) {
                case 'title':
                    projectArray.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'supervisor':
                    projectArray.sort((a, b) => a.primarySupervisor.localeCompare(b.primarySupervisor));
                    break;
                case 'type':
                    projectArray.sort((a, b) => a.type.localeCompare(b.type));
                    break;
                case 'id':
                    projectArray.sort((a, b) => a.id.localeCompare(b.id));
                    break;
                case 'random':
                default:
                    // Use the original random order established at page load
                    const originalOrder = [...projects];
                    shuffleArray(originalOrder, randomSeed);
                    projectArray.sort((a, b) => {
                        const indexA = originalOrder.findIndex(p => p.id === a.id);
                        const indexB = originalOrder.findIndex(p => p.id === b.id);
                        return indexA - indexB;
                    });
                    break;
            }
        }

        function filterProjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const subjectFilter = document.getElementById('subjectFilter').value;
            const supervisorFilter = document.getElementById('supervisorFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            filteredProjects = projects.filter(project => {
                const matchesSearch = !searchTerm || 
                    project.title.toLowerCase().includes(searchTerm) ||
                    project.outline.toLowerCase().includes(searchTerm) ||
                    project.aim.toLowerCase().includes(searchTerm) ||
                    project.type.toLowerCase().includes(searchTerm) ||
                    project.primarySupervisor.toLowerCase().includes(searchTerm) ||
                    (project.secondarySupervisor && project.secondarySupervisor.toLowerCase().includes(searchTerm)) ||
                    project.subjects.some(subject => subject.toLowerCase().includes(searchTerm)) ||
                    project.techniques.some(tech => tech.toLowerCase().includes(searchTerm));

                const matchesType = !typeFilter || project.type === typeFilter;
                const matchesSubject = !subjectFilter || project.subjects.includes(subjectFilter);
                const matchesSupervisor = !supervisorFilter || 
                    project.primarySupervisor === supervisorFilter ||
                    (project.secondarySupervisor && project.secondarySupervisor.includes(supervisorFilter));

                return matchesSearch && matchesType && matchesSubject && matchesSupervisor;
            });

            // Apply sorting
            sortProjects(filteredProjects, sortFilter);
            displayProjects(filteredProjects);
        }

        function toggleSavedPanel() {
            const panel = document.getElementById('savedPanel');
            panel.classList.toggle('open');
        }

        function toggleSaveProject(projectId) {
            const index = savedProjects.findIndex(p => p.id === projectId);
            
            if (index > -1) {
                // Remove from saved
                savedProjects.splice(index, 1);
            } else {
                // Add to saved
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    savedProjects.push(project);
                }
            }
            
            localStorage.setItem('savedProjects', JSON.stringify(savedProjects));
            updateSavedDisplay();
            displayProjects(filteredProjects); // Refresh display to update save buttons
        }

        function updateSavedDisplay() {
            const badge = document.getElementById('savedBadge');
            const savedList = document.getElementById('savedProjectsList');
            const projectCount = document.getElementById('projectCount');
            
            // Update counter in header
            if (projectCount) {
                projectCount.textContent = savedProjects.length;
            }
            
            // Update badge
            if (savedProjects.length > 0) {
                badge.textContent = savedProjects.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
            
            // Update saved projects list
            if (savedProjects.length === 0) {
                savedList.innerHTML = `
                    <div class="no-saved-projects">
                        <h3>No projects saved yet</h3>
                        <p>Click the heart icon on projects you're interested in to add them to your list.</p>
                    </div>
                `;
            } else {
                savedList.innerHTML = savedProjects.map((project, index) => `
                    <div class="saved-project-item" draggable="true" data-index="${index}" 
                         ondragstart="event.dataTransfer.setData('text/plain', ${index})"
                         ondragenter="event.target.closest('.saved-project-item').classList.add('dragging')"
                         ondragleave="event.target.closest('.saved-project-item').classList.remove('dragging')">
                        <button class="saved-project-remove" onclick="toggleSaveProject('${project.id}')">×</button>
                        <div class="saved-project-rank">${index + 1}</div>
                        <div class="saved-project-title">${project.title}</div>
                        <div class="saved-project-meta">ID: ${project.id} • ${project.primarySupervisor}</div>
                    </div>
                `).join('');
            }
        }

        function exportProjectList() {
            if (savedProjects.length === 0) {
                alert('No projects saved to export!');
                return;
            }
            
            if (savedProjects.length < 30) {
                const confirmed = confirm(`You have only selected ${savedProjects.length} projects. Students are expected to rank 30 projects for the best chance of assignment.\n\nDo you want to continue anyway?`);
                if (!confirmed) {
                    return;
                }
            }
            
            const projectIds = savedProjects.map(p => p.id).join('\n');
            
            // Create formatted text for easy form filling
            const formattedText = projectIds;
            const instructionText = `Instructions:
1. Your project preferences are copied to clipboard
2. In the Microsoft Form, paste them in the "Project Preferences" field
3. Add your Student ID
4. Submit the form

Project IDs (in order of preference):
${projectIds}`;
            
            const formsUrl = 'https://forms.office.com/e/vnjxNDXfhd';
            
            // Copy to clipboard and open form
            navigator.clipboard.writeText(formattedText).then(() => {
                window.open(formsUrl, '_blank');
                alert('Project IDs copied to clipboard! Paste them into the "Project Preferences" field in the form that just opened.');
            }).catch(() => {
                window.open(formsUrl, '_blank');
                alert(instructionText);
            });
        }

        function copyProjectList() {
            if (savedProjects.length === 0) {
                alert('No projects saved to copy!');
                return;
            }
            
            const projectIds = savedProjects.map(p => p.id).join(', ');
            navigator.clipboard.writeText(projectIds).then(() => {
                alert('Project IDs copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy to clipboard. Please try the export function instead.');
            });
        }

        function clearAllSaved() {
            if (confirm('Are you sure you want to clear all saved projects?')) {
                savedProjects = [];
                localStorage.setItem('savedProjects', JSON.stringify(savedProjects));
                updateSavedDisplay();
                displayProjects(filteredProjects);
            }
        }

        function toggleCard(cardElement) {
            cardElement.classList.toggle('expanded');
            const button = cardElement.querySelector('.expand-button .expand-text');
            const isExpanded = cardElement.classList.contains('expanded');
            button.textContent = isExpanded ? 'Show less' : 'Show details';
        }

        function displayProjects(projectsToShow) {
            const projectsGrid = document.getElementById('projectsGrid');
            const noResults = document.getElementById('noResults');
            const resultCount = document.getElementById('resultCount');

            resultCount.textContent = projectsToShow.length;

            if (projectsToShow.length === 0) {
                projectsGrid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            projectsGrid.style.display = 'grid';
            noResults.style.display = 'none';

            projectsGrid.innerHTML = projectsToShow.map((project, index) => {
                const isSaved = savedProjects.some(p => p.id === project.id);
                
                return `
                    <div class="project-card ${isSaved ? 'saved' : ''}" id="card-${index}">
                        <div class="card-header">
                            <button class="save-button ${isSaved ? 'saved' : ''}" onclick="toggleSaveProject('${project.id}')" title="${isSaved ? 'Remove from saved' : 'Save project'}">
                                ${isSaved ? '−' : '+'}
                            </button>
                            <h3 class="project-title">${project.title}</h3>
                            
                            <div class="project-meta">
                                <div class="meta-chip type" data-type="${project.type}">${project.type}</div>
                            </div>

                            <div class="subject-tags">
                                ${project.subjects.map(subject => `
                                    <div class="subject-chip">${subject}</div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="card-content">
                            <div class="project-aim">
                                <strong>Aim:</strong> ${project.aim}
                            </div>

                            <div class="techniques-section">
                                <div class="section-label">Key techniques</div>
                                <div class="techniques-list">
                                    ${project.techniques.map(technique => `
                                        <div class="technique-chip">${technique}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="project-details">
                            <div class="project-outline">
                                <div class="section-label">Project outline</div>
                                ${project.outline}
                            </div>

                            ${project.references ? `
                            <div class="references-section">
                                <div class="section-label">Key references</div>
                                <div class="references-list">
                                    ${project.references.map(ref => `<div class="reference">${ref}</div>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <div class="card-actions">
                            <div class="supervisor-info">
                                <strong>Project ID:</strong> ${project.id}<br>
                                <strong>Primary supervisor:</strong> ${project.primarySupervisor}<br>
                                <strong>Secondary supervisor:</strong> ${project.secondarySupervisor || 'N/A'}
                            </div>
                            
                            <button class="expand-button" onclick="toggleCard(document.getElementById('card-${index}'))">
                                <span class="expand-text">Show details</span>
                                <span class="expand-icon">▼</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
